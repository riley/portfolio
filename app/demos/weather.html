<!DOCTYPE html>
<html>
<head>
<title>D3 Weather App</title>
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
<style>
body {padding: 0; margin: 0;}
* { font-family: 'Lato', sans-serif; }
.cities {
    padding: 0;
}
.cities li {
    list-style: none;
    background: #eee;
    padding: 5px 8px;
    cursor: pointer;
    display: inline-block;
    margin-right: 3px;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.cities li:hover {
    background: #ccc;
}
.cities li.active {
    background: pink;
}

.axis path,
.axis line {
    fill: none;
    stroke: #000;
    stroke-opacity: .3;
    shape-rendering: crispEdges;
}

.axis text {
    font-size: 11px;
    fill: #888;
}

.x .tick line {
    shape-rendering: crispEdges;
    stroke: #000;
    stroke-width: 1px;
    stroke-dasharray: 2,2;
    stroke-opacity: .3;
}

.precip {
    fill: none;
    stroke: lightblue;
    stroke-width: 1px;
}

.median {
    stroke: black;
    stroke-width: 1px;
    fill: none;
}

.average-bar, .quart, .bar, .median {
    pointer-events: none;
}

#sunshine .y .tick line, #sunshine path {
    stroke-opacity: 0;
}

</style>
</head>
<body>
    <main>
        <article>
            <svg id="chart"></svg>
            <ul id="cities" class="cities"></ul>
            <p>And sunshine of all cities</p>
            <svg id="sunshine"></svg>
        </article>
    </main>
<script src="js/d3.min.js"></script>
<script>
/* global d3 */
'use strict';

NodeList.prototype.forEach = Array.prototype.forEach;

(function () {
    var cities = [];
    var loaded = 0;

    var svg;
    var x, y;
    var width, height;
    // var line;
    var averages, dailies;

    var bars;


    function init() {
        var cityUl = document.getElementById('cities');

        var fileList = ['averages', 'dailies'];

        function toDate(o) {
            o.date = new Date(o.date);
        }

        fileList.forEach(function (file, i) {

            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'data/' + file + '.json');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var json = JSON.parse(xhr.responseText);
                    if (file === 'averages') {
                        averages = json;
                        cities = Object.keys(averages);
                        Object.keys(averages).forEach(function (city, i) {
                            cityUl.insertAdjacentHTML('beforeend', '<li class="city-name">' + city + '</li>');
                            cityUl.childNodes[cityUl.childNodes.length - 1].addEventListener('click', updateCity);
                            if (i === 0) {
                                cityUl.childNodes[0].classList.add('active');
                            }

                            averages[city].forEach(toDate);
                        });
                    } else if (file === 'dailies') {
                        dailies = json;
                        Object.keys(dailies).forEach(function (city) {
                            dailies[city].forEach(toDate);
                        });
                    }

                    if (++loaded === fileList.length) draw();
                } else {
                    console.log('failed to load file ' + file + ' ' + xhr.status);
                }
            };
            xhr.send(null);
        });
    }

    function draw() {
        console.log('averages', averages, 'dailies', dailies);

        var windowWidth = window.innerWidth - 100;

        var margin = {top: 40, right: 50, bottom: 30, left: 40};
        width = windowWidth - margin.left - margin.right;
        height = windowWidth / 3 - margin.top - margin.bottom;
        var barWidth = width / 365 - 1;

        var initCity = cities[0];

        x = d3.time.scale()
            .domain([new Date(2014, 0, 1), new Date(2014, 11, 31)])
            .range([0, width]);
        y = d3.scale.linear().domain([0, 100]).range([height, 0]);

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient('left')
            .ticks(5);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient('bottom')
            .ticks(d3.time.months)
            .tickFormat(d3.time.format('%B'));

        svg = d3.select('#chart')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        // add the tick marks on y axis
        svg.append('g')
            .attr('class', 'y axis left')
            .call(yAxis)
            .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 6)
                .attr('dy', '.71em')
                .style('text-anchor', 'end')
                .text('temp Â°F');

        svg.append('g') // x axis
            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + y(0) + ')') // cross @ 0
            .call(xAxis)
            .selectAll('.tick text')
                .style('text-anchor', 'start')
                .attr('x', 6)
                .attr('y', 6);

        svg.selectAll('.x .tick line')
            .attr('transform', 'translate(0,' + -height + ')')
            .attr('y2', height);

        // make mouseover targets the entire height of visualization for usability
        svg.selectAll('.conditions')
            .data(dailies[initCity])
            .enter().append('rect')
                .attr('class', 'conditions')
                .attr('x', function (d) { return x(d.date); })
                .attr('y', y(105))
                .attr('width', barWidth)
                .attr('height', y(97))
                .attr('fill', '#ed0')
                .attr('fill-opacity', function (d) { return d.conds; });

        // averages
        svg.selectAll('.average-bar')
            .data(averages[initCity])
            .enter().append('rect')
                .attr('class', 'average-bar')
                .attr('x', function (d) { return x(d.date); })
                .attr('y', function (d) { return y(d.maxAvg); })
                .attr('width', barWidth)
                .attr('height', function (d) { return height - y(d.maxAvg - d.minAvg); })
                .attr('fill', '#aec7e8');
                // .attr('fill-opacity', 0.5);


        // draw inner quartile
        svg.selectAll('.quart')
            .data(averages[initCity])
            .enter().append('rect')
                .attr('class', 'quart')
                .attr('x', function (d) { return x(d.date); })
                .attr('y', function (d) { return y(d3.quantile(d.numbers, 0.75)); })
                .attr('width', barWidth)
                .attr('height', function (d) {
                    return height - y(d3.quantile(d.numbers, 0.75) - d3.quantile(d.numbers, 0.25));
                })
                .attr('fill', '#1f77b4');

        // draw the median
        svg.selectAll('.median')
            .data(averages[initCity])
            .enter().append('line')
                .attr('class', 'median')
                .attr('x1', function (d) { return x(d.date); })
                .attr('x2', function (d) { return x(d.date) + barWidth; })
                .attr('transform', function (d) { return 'translate(0,' + y(d3.quantile(d.numbers, 0.5)) + ')'; });

        // add all the 2014 bars
        bars = svg.selectAll('.bar')
            .data(dailies[initCity])
            .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', function (d) { return x(d.date); })
                .attr('y', function (d) { return y(d.high); })
                .attr('width', barWidth)
                .attr('height', function (d) { return height - y(d.high - d.low); })
                .attr('fill', 'black')
                .attr('fill-opacity', 0);

        svg.selectAll('.hit')
            .data(dailies[initCity])
            .enter().append('rect')
                .attr('class', 'hit')
                .attr('x', function (d) { return x(d.date); })
                .attr('y', 0)
                .attr('width', barWidth)
                .attr('height', height)
                .attr('fill', '#000')
                .attr('fill-opacity', 0)
                .on('mouseover', showDetail);

        var sMargin = {top: 10, right: 50, bottom: 30, left: 100};
        var sWidth = windowWidth - sMargin.left - sMargin.right;
        var sHeight = height / 3 - sMargin.top - sMargin.bottom;
        var sY = d3.scale.linear().domain([0, cities.length]).range([sHeight, 0]);
        var sX = d3.time.scale()
            .domain([new Date(2014, 0, 1), new Date(2014, 11, 31)])
            .range([0, sWidth]);

        /* show the sunshine measurements in one grid */
        var sunshine = d3.select('#sunshine')
            .attr('width', sWidth + sMargin.left + sMargin.right)
                .attr('height', sHeight + sMargin.top + sMargin.bottom)
                .append('g')
                    .attr('transform', 'translate(' + sMargin.left + ',' + sMargin.top + ')');

        var sunYAxis = d3.svg.axis()
            .scale(sY)
            .orient('left')
            .tickFormat(function (d, i) { return cities[i]; })
            .tickValues(d3.range(cities.length));

        sunshine.append('g')
            .attr('class', 'y axis')
            .call(sunYAxis)
            .attr('transform', 'translate(0,' + sY(cities.length - 1) / 2 + ')');

        var row = sunshine.selectAll('.row')
            .data(cities)
            .enter().append('g')
                .attr('class', 'row')
                .attr('transform', function (d, i) { return 'translate(0, ' + sY(i) + ')'; });

        row.selectAll('.sun')
            .data(function (d) { return dailies[d]; })
            .enter().append('rect')
                .attr('class', 'sun')
                .attr('x', function (d) { return sX(d.date); })
                .attr('width', barWidth)
                .attr('height', function () { return sY(cities.length - 1) - 2; })
                .attr('fill', '#ed0')
                .attr('fill-opacity', function (d) { return d.conds; });
    }

    function updateCity(e) {

        var currentCity = e.target.textContent;

        console.log(e);
        svg.selectAll('.bar')
            .data(dailies[currentCity])
            .transition()
            .attr('y', function (d) { return y(d.high); })
            .attr('height', function (d) { return height - y(d.high - d.low); });

        // averages
        svg.selectAll('.average-bar')
            .data(averages[currentCity])
            .transition()
                .attr('y', function (d) { return y(d.maxAvg); })
                .attr('height', function (d) { return height - y(d.maxAvg - d.minAvg); });

        svg.selectAll('.quart')
            .data(averages[currentCity])
            .transition()
                .attr('y', function (d) { return y(d3.quantile(d.numbers, 0.75)); })
                .attr('height', function (d) {
                    return height - y(d3.quantile(d.numbers, 0.75) - d3.quantile(d.numbers, 0.25));
                });

        svg.selectAll('.median')
            .data(averages[currentCity])
            .transition()
                .attr('transform', function (d) { return 'translate(0,' + y(d3.quantile(d.numbers, 0.5)) + ')'; });

        svg.selectAll('.conditions')
            .data(dailies[currentCity])
            .transition()
                .attr('fill-opacity', function (d) { return d.conds; });


        // svg.select('.precip')
        //     .data([dailies[e.target.textContent]])
        //     .transition()
        //         .attr('d', line);

        document.querySelectorAll('.city-name').forEach(function (node) { node.classList.remove('active'); });
        e.target.classList.add('active');
    }

    function showDetail(d, index) {
        var spread = 20;
        bars.attr('fill-opacity', function (d, i) {
            var offset = Math.abs(i - index);
            if (offset < spread) {
                // return 1 - offset / spread;
                return 0.5;
            } else {
                return 0;
            }
            // return i / offset;
        });

    }

    init();
})();
</script>
</body>
</html>